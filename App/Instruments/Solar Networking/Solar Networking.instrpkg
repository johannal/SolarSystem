<?xml version="1.0" encoding="UTF-8" ?>
<package>
    <id>com.demo.solarsystem.networking</id>
    <title>Solar System Networking</title>
    <owner>
        <name>Kacper</name>
    </owner>
    <note>Package that provides instrumentation for REST API calls and parsing operations.</note>
    <import-schema>os-signpost</import-schema>

    <os-signpost-interval-schema>
        <id>http-request</id>
        <title>Aggregated HTTP requests</title>

        <subsystem>"com.demo.SolarSystem"</subsystem>
        <category>"Networking"</category>
        <name>"NetworkRequest"</name>

        <start-pattern>
            <message>"Request started [ID:" ?request-id "][URL:" ?url "][TYPE:" ?request-type "][CATEGORY:" ?category "]"</message>
        </start-pattern>
        <end-pattern>
            <message>"Request finished [ID:" ?request-id "][CODE:" ?http-code"]"</message>
        </end-pattern>
        <primary-column>
            <mnemonic>request-id</mnemonic>
            <title>Request identifier</title>
            <type>uint64</type>
            <expression>?request-id</expression>
        </primary-column>

        <column>
            <mnemonic>url</mnemonic>
            <title>Request URL</title>
            <type>string</type>
            <expression>?url</expression>
        </column>

        <column>
            <mnemonic>category</mnemonic>
            <title>Request category</title>
            <type>string</type>
            <expression>?category</expression>
        </column>

        <column>
            <mnemonic>request-type</mnemonic>
            <title>HTTP Request Type</title>
            <type>string</type>
            <expression>?request-type</expression>
        </column>

        <column>
            <mnemonic>request-label</mnemonic>
            <title>HTTP Request Label</title>
            <type>string</type>
            <expression>(str-cat "[" ?request-type "] " ?url " â€” " ?http-code)</expression>
        </column>

        <column>
            <mnemonic>http-code</mnemonic>
            <title>HTTP Response code</title>
            <type>uint64</type>
            <expression>?http-code</expression>
        </column>

        <column>
            <mnemonic>end-present</mnemonic>
            <title>End signpost present</title>
            <type>boolean</type>
            <expression>(integer 1)</expression>
        </column>

        <column>
            <mnemonic>request-color</mnemonic>
            <title>Request Color</title>
            <type>event-concept</type>
            <expression>(switch ?http-code (case 200 then "Green") (default "Red"))</expression>
        </column>

        <open-interval-template>
            <mnemonic>request-id</mnemonic>
            <expression>?request-id</expression>
            <mnemonic>category</mnemonic>
            <expression>?category</expression>
            <mnemonic>url</mnemonic>
            <expression>?url</expression>
            <mnemonic>request-type</mnemonic>
            <expression>?request-type</expression>
            <mnemonic>request-label</mnemonic>
            <expression>(str-cat "[" ?request-type "]" ?url)</expression>
        </open-interval-template>

    </os-signpost-interval-schema>

    <os-signpost-interval-schema>
        <id>json-parsing</id>
        <title>Aggregated JSON parsing operations</title>

        <subsystem>"com.demo.SolarSystem"</subsystem>
        <category>"Networking"</category>
        <name>"ResponseParsing"</name>
        <identifier>?identifier</identifier>

        <start-pattern>
            <message>"[ID:" ?request-id "][SIZE:" ?bytes "]"</message>
        </start-pattern>
        <end-pattern>
            <message>"[ID:" ?request-id "]"</message>
        </end-pattern>
        <primary-column>
            <mnemonic>request-id</mnemonic>
            <title>Request identifier</title>
            <type>uint64</type>
            <expression>?request-id</expression>
        </primary-column>

        <column>
            <mnemonic>size-in-bytes</mnemonic>
            <title>Bytes</title>
            <type>size-in-bytes</type>
            <expression>?bytes</expression>
        </column>

        <column>
            <mnemonic>identifier</mnemonic>
            <title>Identifier</title>
            <type>os-signpost-identifier</type>
            <expression>?identifier</expression>
        </column>

        <open-interval-template>
            <mnemonic>request-id</mnemonic>
            <expression>?request-id</expression>
            <mnemonic>identifier</mnemonic>
            <expression>?identifier</expression>
            <mnemonic>size-in-bytes</mnemonic>
            <expression>?bytes</expression>
        </open-interval-template>

    </os-signpost-interval-schema>

    <point-schema>
        <id>request-start</id>
        <title>Request Start Events</title>

        <timestamp-column>
            <mnemonic>time</mnemonic>
            <title>Timestamp</title>
            <type>sample-time</type>
        </timestamp-column>

        <column>
            <mnemonic>url</mnemonic>
            <title>Request URL</title>
            <type>string</type>
        </column>

        <column>
            <mnemonic>category</mnemonic>
            <title>Request category</title>
            <type>string</type>
        </column>

        <column>
            <mnemonic>request-type</mnemonic>
            <title>HTTP Request Type</title>
            <type>string</type>
        </column>

        <column>
            <mnemonic>request-label</mnemonic>
            <title>HTTP Request Label</title>
            <type>string</type>
        </column>

        <column>
            <mnemonic>identifier</mnemonic>
            <title>Identifier</title>
            <type>os-signpost-identifier</type>
        </column>

    </point-schema>

    <point-schema>
        <id>request-narrative</id>
        <title>Requests Narrative</title>

        <timestamp-column>
            <mnemonic>time</mnemonic>
            <title>Timestamp</title>
            <type>sample-time</type>
        </timestamp-column>

        <column>
            <mnemonic>narrative</mnemonic>
            <title>Narrative</title>
            <type>narrative-text</type>
        </column>
    </point-schema>

    <modeler>
        <id>com.demo.solarsystem.signpost-to-points</id>
        <title>Generates points data out of the signpost table</title>
        <purpose>Takes raw data from os-signpost table and puts it into resulting schema</purpose>

        <production-system>
            <rule-path>category-points.clp</rule-path>
        </production-system>

        <output>
            <schema-ref>request-start</schema-ref>
            <required-input>
                <schema-ref>os-signpost</schema-ref>
            </required-input>
        </output>
    </modeler>


    <modeler>
        <id>com.demo.solarsystem.unnecessary-retry-detection</id>
        <title>Unnecessary retry detector</title>
        <purpose>Generates warnings into narrative table whenever unnecessary retry happens.</purpose>

        <production-system>
            <rule-path>unnecessary-retry-detection.clp</rule-path>
        </production-system>

        <output>
            <schema-ref>request-narrative</schema-ref>
            <required-input>
                <schema-ref>os-signpost</schema-ref>
            </required-input>
            <required-input>
                <schema-ref>http-request</schema-ref>
            </required-input>
        </output>
    </modeler>

    <instrument>
        <id>com.demo.solarsystem.networking.http-activity</id>
        <title>HTTP Activity</title>
        <category>Behavior</category>
        <purpose>Displays HTTP requests and JSON parsing operations.</purpose>
        <icon>Network</icon>

        <limitations>
            <disable>
                <when-target-is>All Processes</when-target-is>
            </disable>
        </limitations>

        <create-table>
            <id>http-request-table</id>
            <schema-ref>http-request</schema-ref>
        </create-table>

        <create-table>
            <id>request-start-table</id>
            <schema-ref>request-start</schema-ref>
        </create-table>

        <create-table>
            <id>request-narrative-table</id>
            <schema-ref>request-narrative</schema-ref>
        </create-table>

        <graph>
            <title>Endpoint requests</title>
            <lane>
                <title></title>
                <table-ref>request-start-table</table-ref>
                <plot-template>
                    <instance-by>category</instance-by>
                    <label-format>%s</label-format>
                    <value-from>identifier</value-from>
                    <label-from>request-label</label-from>
                </plot-template>
            </lane>
        </graph>

        <aggregation>
            <title>Summary</title>
            <table-ref>http-request-table</table-ref>
            <slice>
                <column>end-present</column>
                <equals>
                    <boolean>1</boolean>
                </equals>
            </slice>
            <hierarchy>
                <level>
                    <column>url</column>
                </level>
                <level>
                    <column>http-code</column>
                </level>
            </hierarchy>
            <visit-on-focus>HTTP Requests List</visit-on-focus>
            <column>
                <count/>
            </column>
            <column>
                <title>Total Duration</title>
                <sum>duration</sum>
            </column>
            <column>
                <min>duration</min>
            </column>
            <column>
                <average>duration</average>
            </column>
            <column>
                <max>duration</max>
            </column>
            <column>
                <std-dev>duration</std-dev>
            </column>
        </aggregation>

        <narrative>
            <title>Narrative</title>
            <table-ref>request-narrative-table</table-ref>
            <time-column>time</time-column>
            <narrative-column>narrative</narrative-column>
        </narrative>

        <list>
            <title>HTTP Requests List</title>
            <table-ref>http-request-table</table-ref>
            <column>start</column>
            <column>duration</column>
            <column>request-id</column>
            <column>url</column>
            <column>http-code</column>
        </list>

        <time-slice>
            <title>Active requests</title>
            <table-ref>http-request-table</table-ref>
            <column>start</column>
            <column>duration</column>
            <column>request-id</column>
            <column>url</column>
            <column>http-code</column>
        </time-slice>

        <defaults>
            <graph-height>4</graph-height>
            <target-type>Running Application</target-type>
        </defaults>

    </instrument>

    <instrument>
        <id>com.demo.solarsystem.networking.json-parsing</id>
        <title>JSON Parsing</title>
        <category>Behavior</category>
        <purpose>Displays JSON parsing operations.</purpose>
        <icon>Network</icon>

        <limitations>
            <disable>
                <when-target-is>All Processes</when-target-is>
            </disable>
        </limitations>

        <create-table>
            <id>json-parsing</id>
            <schema-ref>json-parsing</schema-ref>
        </create-table>

        <graph>
            <title>Endpoint requests</title>
            <lane>
                <title>JSON Parsing</title>
                <table-ref>json-parsing</table-ref>
                <base-color>Blue</base-color>
                <plot>
                    <value-from>identifier</value-from>
                    <label-from>size-in-bytes</label-from>
                </plot>
            </lane>
        </graph>

        <list>
            <title>JSON Parsing operations</title>
            <table-ref>json-parsing</table-ref>
            <column>start</column>
            <column>duration</column>
            <column>request-id</column>
            <column>size-in-bytes</column>
        </list>

        <defaults>
            <graph-height>1</graph-height>
            <target-type>Running Application</target-type>
        </defaults>

    </instrument>

    <instrument>
        <id>com.demo.solarsystem.networking.average-started-requests</id>
        <title>Request Load</title>
        <category>Behavior</category>
        <purpose>Displays started requests histogram over time</purpose>
        <icon>Network</icon>
        <limitations>
            <disable>
                <when-target-is>All Processes</when-target-is>
            </disable>
        </limitations>

        <create-table>
            <id>request-start-table</id>
            <schema-ref>request-start</schema-ref>
        </create-table>

        <graph>
            <title>Requests started</title>
            <lane>
                <title>Requests started</title>
                <table-ref>request-start-table</table-ref>
                <histogram>
                    <nanoseconds-per-bucket>500000000</nanoseconds-per-bucket>
                    <count></count>
                </histogram>
            </lane>
        </graph>

        <list>
            <title>Requests started</title>
            <table-ref>request-start-table</table-ref>
            <column>url</column>
        </list>

        <defaults>
            <graph-height>1</graph-height>
            <target-type>Running Application</target-type>
        </defaults>

    </instrument>

    <template>
        <import-from-file>Solar System.tracetemplate</import-from-file>
    </template>

</package>
